<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Productos – Bodegón App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <!-- SweetAlert -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

  <style>
    body { background:#f8f9fa; }
    .sidebar {
      position:fixed;
      top:0;
      right:-450px;
      width:450px;
      height:100%;
      background:#fff;
      box-shadow:-2px 0 8px rgba(0,0,0,.15);
      transition:right .3s;
      z-index:1050;
      overflow-y:auto;
    }
    .sidebar.open { right:0; }
    .overlay {
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,.4);
      z-index:1040;
      display:none;
    }
    .img-thumbnail { cursor:pointer; }
    .img-preview { width:60px;height:60px;object-fit:cover;border-radius:.25rem;margin-right:.25rem; }
    .nav-tabs .nav-link { font-size:.875rem; }
    .dt-buttons { margin-bottom:1rem; }
    .badge { font-size:.7rem; }
  </style>
</head>
<body>

<!-- Barra superior -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
  <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-boxes-stacked me-2"></i>Gestión de Productos</span>
  <div class="ms-auto d-flex gap-2">
    <input class="form-control form-control-sm" id="searchBox" placeholder="Buscar…" style="width:220px;">
    <button class="btn btn-success btn-sm" id="btnNuevo"><i class="fa-solid fa-plus"></i> Nuevo Producto</button>
  </div>
</nav>

<div class="container-fluid mt-4">
  <!-- Filtros rápidos -->
  <div class="row mb-3">
    <div class="col-md-3">
      <select id="filtroCategoria" class="form-select form-select-sm">
        <option value="">Todas las categorías</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="filtroEstado" class="form-select form-select-sm">
        <option value="">Estado</option>
        <option value="1">Activo</option>
        <option value="0">Inactivo</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="filtroStock" class="form-select form-select-sm">
        <option value="">Stock</option>
        <option value="con">Con stock</option>
        <option value="bajo">Bajo stock</option>
        <option value="sin">Sin stock</option>
      </select>
    </div>
  </div>

  <!-- Tabla -->
  <table class="table table-hover table-sm align-middle" id="tablaProductos" style="width:100%">
    <thead class="table-light">
      <tr>
        <th></th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Fondo oscuro al abrir sidebar -->
<div class="overlay" id="overlay"></div>

<!-- Sidebar -->
<div class="sidebar p-4" id="sidebar">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 id="tituloSidebar">Nuevo Producto</h5>
    <button class="btn-close" id="btnCerrarSidebar"></button>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-info">Info</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-precios">Precios</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-variantes">Variantes</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-imagenes">Imágenes</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-historial">Historial</button></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- 1. Info General -->
    <div class="tab-pane fade show active" id="tab-info">
      <div class="mb-3">
        <label class="form-label">Nombre del producto</label>
        <input type="text" class="form-control form-control-sm" id="prodNombre">
      </div>
      <div class="mb-3">
        <label class="form-label">Descripción corta</label>
        <input type="text" class="form-control form-control-sm" id="prodDescCorta">
      </div>
      <div class="mb-3">
        <label class="form-label">Descripción larga</label>
        <textarea class="form-control form-control-sm" rows="3" id="prodDescLarga"></textarea>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Categoría</label>
          <select class="form-select form-select-sm" id="prodCategoria"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Marca</label>
          <input type="text" class="form-control form-control-sm" id="prodMarca">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Código interno</label>
          <input type="text" class="form-control form-control-sm" id="prodCodInterno">
        </div>
        <div class="col-md-6">
          <label class="form-label">Código de barras</label>
          <input type="text" class="form-control form-control-sm" id="prodCodBarras">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Unidad de medida</label>
          <select class="form-select form-select-sm" id="prodUnidad">
            <option>Unidad</option><option>Litro</option><option>Kg</option><option>Pack</option>
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="prodActivo" checked>
            <label class="form-check-label">Activo</label>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Precios -->
    <div class="tab-pane fade" id="tab-precios">
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Costo ($)</label>
          <input type="number" step="0.01" class="form-control form-control-sm" id="precioCosto">
        </div>
        <div class="col-md-4">
          <label class="form-label">Margen (%)</label>
          <input type="number" step="0.1" class="form-control form-control-sm" id="precioMargen">
        </div>
        <div class="col-md-4">
          <label class="form-label">Precio venta ($)</label>
          <input type="number" step="0.01" class="form-control form-control-sm" id="precioVenta">
        </div>
      </div>
      <small class="text-muted">Precios por canal (opcional)</small>
      <div class="row mt-2">
        <div class="col-md-4">
          <label class="form-label">Local</label>
          <input type="number" step="0.01" class="form-control form-control-sm" id="precioLocal">
        </div>
        <div class="col-md-4">
          <label class="form-label">Delivery</label>
          <input type="number" step="0.01" class="form-control form-control-sm" id="precioDelivery">
        </div>
        <div class="col-md-4">
          <label class="form-label">Tienda online</label>
          <input type="number" step="0.01" class="form-control form-control-sm" id="precioOnline">
        </div>
      </div>
      <hr>
      <label class="form-label">Historial de precios</label>
      <div style="max-height:200px;overflow-y:auto">
        <table class="table table-sm table-striped" id="tablaHistorialPrecios">
          <thead><tr><th>Fecha</th><th>Precio</th><th>Motivo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 3. Variantes -->
    <div class="tab-pane fade" id="tab-variantes">
      <button class="btn btn-outline-primary btn-sm mb-2" id="btnAddVariante"><i class="fa-solid fa-plus"></i> Agregar variante</button>
      <div id="listaVariantes"></div>
    </div>

    <!-- 4. Imágenes -->
    <div class="tab-pane fade" id="tab-imagenes">
      <input type="file" id="inputImagenes" multiple accept="image/*" class="form-control form-control-sm mb-2">
      <div id="previewImagenes" class="d-flex flex-wrap"></div>
    </div>

    <!-- 5. Historial -->
    <div class="tab-pane fade" id="tab-historial">
      <div id="logCambios"></div>
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-4">
    <button class="btn btn-outline-secondary btn-sm" id="btnCancelar">Cancelar</button>
    <button class="btn btn-primary btn-sm" id="btnGuardar">Guardar</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* Datos de ejemplo */
let categorias = ['Bebidas','Cervezas','Artesanales','Rubias','500ml'];
let productos = [
  { id:1, nombre:'Cerveza Rubia 500ml', categoria:'Cervezas', precio:1200, stock:24, activo:true,
    descCorta:'Cerveza artesanal rubia', descLarga:'Descripción larga...', marca:'Patagonia',
    codInterno:'CR500', codBarras:'1234567890123', unidad:'Unidad',
    costo:800, margen:50, precios:{ local:1200, delivery:1300, online:1250 },
    variantes:[ { nombre:'500ml', codBarras:'1234567890123', stock:24, precio:1200 } ],
    imagenes:['https://via.placeholder.com/150'], historialPrecios:[ { fecha:'29/08/2025', precio:1200, motivo:'Alta producto' } ],
    log:[ { fecha:'29/08/2025 10:00', usuario:'Admin', cambio:'Alta producto' } ]
  }
];
let idGlobal = 2;

/* Inicializar */
$(function(){
  initTabla();
  llenarSelectCategorias();
  listeners();
});

function initTabla(){
  window.tabla = $('#tablaProductos').DataTable({
    dom: 'Bfrtip',
    buttons: ['excelHtml5','pdfHtml5'],
    language: { url:'//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
    data: productos,
    columns: [
      { data:'imagenes', render: url => `<img src="${url[0]}" class="rounded" width="40">`, orderable:false },
      { data:'nombre' },
      { data:'categoria' },
      { data:'precio', render: p => `$${p.toLocaleString()}` },
      { data:'stock' },
      { data:'activo', render: v => v ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-secondary">Inactivo</span>' },
      { data:null, render: acciones, orderable:false }
    ]
  });
}

function acciones(data){
  return `
    <button class="btn btn-sm btn-outline-primary" onclick="editar(${data.id})"><i class="fa-solid fa-edit"></i></button>
    <button class="btn btn-sm btn-outline-secondary" onclick="clonar(${data.id})"><i class="fa-solid fa-copy"></i></button>
    <button class="btn btn-sm ${data.activo?'btn-outline-danger':'btn-outline-success'}" onclick="toggleActivo(${data.id})">
      <i class="fa-solid fa-${data.activo?'times':'check'}"></i>
    </button>`;
}

function llenarSelectCategorias(){
  $('#prodCategoria, #filtroCategoria').html('<option value="">Seleccione</option>');
  categorias.forEach(c=>{
    $('#prodCategoria, #filtroCategoria').append(`<option value="${c}">${c}</option>`);
  });
}

function listeners(){
  $('#btnNuevo, #btnCancelar, #btnCerrarSidebar, #overlay').on('click', cerrarSidebar);
  $('#btnGuardar').on('click', guardarProducto);
  $('#btnAddVariante').on('click', addVarianteUI);
  $('#inputImagenes').on('change', previewImagenes);
  $('#searchBox').on('keyup', ()=> tabla.search($('#searchBox').val()).draw());
  $('#filtroCategoria, #filtroEstado, #filtroStock').on('change', filtrosTabla);
  $('#precioCosto, #precioMargen').on('input', calcularPrecioVenta);
}

function abrirSidebar(){
  $('#sidebar, #overlay').fadeIn();
  $('#sidebar').addClass('open');
}
function cerrarSidebar(){
  $('#sidebar, #overlay').fadeOut(()=> $('#sidebar').removeClass('open'));
  limpiarForm();
}

function limpiarForm(){
  $('#prodNombre, #prodDescCorta, #prodDescLarga, #prodMarca, #prodCodInterno, #prodCodBarras').val('');
  $('#prodCategoria').val('');
  $('#prodActivo').prop('checked',true);
  $('#precioCosto, #precioMargen, #precioVenta, #precioLocal, #precioDelivery, #precioOnline').val('');
  $('#tablaHistorialPrecios tbody').empty();
  $('#listaVariantes').empty();
  $('#previewImagenes').empty();
  $('#logCambios').empty();
}

function addVarianteUI(){
  const id = Date.now();
  $('#listaVariantes').append(`
    <div class="card mb-2" data-id="${id}">
      <div class="card-body py-2">
        <div class="row g-2">
          <div class="col-md-4"><input class="form-control form-control-sm" placeholder="Nombre variante"></div>
          <div class="col-md-3"><input class="form-control form-control-sm" placeholder="Código barras"></div>
          <div class="col-md-2"><input type="number" class="form-control form-control-sm" placeholder="Stock"></div>
          <div class="col-md-2"><input type="number" step="0.01" class="form-control form-control-sm" placeholder="Precio"></div>
          <div class="col-md-1"><button class="btn btn-sm btn-outline-danger" onclick="this.closest('.card').remove()"><i class="fa-solid fa-trash"></i></button></div>
        </div>
      </div>
    </div>`);
}

function previewImagenes(e){
  [...e.target.files].forEach(file=>{
    const url = URL.createObjectURL(file);
    $('#previewImagenes').append(`<img src="${url}" class="img-preview">`);
  });
}

function calcularPrecioVenta(){
  const costo = parseFloat($('#precioCosto').val())||0;
  const margen = parseFloat($('#precioMargen').val())||0;
  if(costo && margen){
    const venta = costo * (1 + margen/100);
    $('#precioVenta').val(venta.toFixed(2));
  }
}

function editar(id){
  const p = productos.find(p=>p.id===id);
  llenarForm(p);
  abrirSidebar();
}
function clonar(id){
  const p = {...productos.find(p=>p.id===id)};
  p.id = idGlobal++;
  p.nombre += ' (copia)';
  productos.push(p);
  tabla.row.add(p).draw();
  Swal.fire('Clonado','Producto duplicado','success');
}
function toggleActivo(id){
  const p = productos.find(p=>p.id===id);
  p.activo = !p.activo;
  tabla.row( productos.indexOf(p) ).data(p).draw();
}

function llenarForm(p){
  $('#prodNombre').val(p.nombre);
  $('#prodDescCorta').val(p.descCorta);
  $('#prodDescLarga').val(p.descLarga);
  $('#prodCategoria').val(p.categoria);
  $('#prodMarca').val(p.marca);
  $('#prodCodInterno').val(p.codInterno);
  $('#prodCodBarras').val(p.codBarras);
  $('#prodUnidad').val(p.unidad);
  $('#prodActivo').prop('checked', p.activo);
  $('#precioCosto').val(p.costo);
  $('#precioMargen').val(p.margen);
  $('#precioVenta').val(p.precio);
  $('#precioLocal').val(p.precios.local);
  $('#precioDelivery').val(p.precios.delivery);
  $('#precioOnline').val(p.precios.online);

  // Historial
  $('#tablaHistorialPrecios tbody').html(
    p.historialPrecios.map(h=>`<tr><td>${h.fecha}</td><td>$${h.precio}</td><td>${h.motivo}</td></tr>`).join('')
  );

  // Variantes
  $('#listaVariantes').empty();
  p.variantes.forEach(v=> addVarianteUI(v));

  // Imágenes
  $('#previewImagenes').html(p.imagenes.map(img=>`<img src="${img}" class="img-preview">`).join(''));

  // Log
  $('#logCambios').html(p.log.map(l=>`<p class="mb-1 small">${l.fecha} - ${l.usuario}: ${l.cambio}</p>`).join(''));
}

function guardarProducto(){
  const p = {
    id: $('#prodNombre').data('id') || idGlobal++,
    nombre: $('#prodNombre').val().trim(),
    descCorta: $('#prodDescCorta').val().trim(),
    descLarga: $('#prodDescLarga').val().trim(),
    categoria: $('#prodCategoria').val(),
    marca: $('#prodMarca').val().trim(),
    codInterno: $('#prodCodInterno').val().trim(),
    codBarras: $('#prodCodBarras').val().trim(),
    unidad: $('#prodUnidad').val(),
    activo: $('#prodActivo').is(':checked'),
    costo: parseFloat($('#precioCosto').val())||0,
    margen: parseFloat($('#precioMargen').val())||0,
    precio: parseFloat($('#precioVenta').val())||0,
    precios:{
      local: parseFloat($('#precioLocal').val())||0,
      delivery: parseFloat($('#precioDelivery').val())||0,
      online: parseFloat($('#precioOnline').val())||0
    },
    variantes: [],
    imagenes: [...$('#previewImagenes img')].map(img=>img.src),
    historialPrecios: [{ fecha:'29/08/2025', precio:parseFloat($('#precioVenta').val())||0, motivo:'Alta/Edición manual' }],
    log: [{ fecha:'29/08/2025 10:00', usuario:'Admin', cambio:'Alta/Edición manual' }]
  };

  // Capturar variantes
  $('#listaVariantes .card').each((_,c)=>{
    const fields = $(c).find('input');
    p.variantes.push({
      nombre: fields.eq(0).val(),
      codBarras: fields.eq(1).val(),
      stock: parseInt(fields.eq(2).val())||0,
      precio: parseFloat(fields.eq(3).val())||0
    });
  });

  // Validación básica
  if(!p.nombre){ Swal.fire('Error','Nombre requerido','warning'); return; }

  // Agregar o actualizar
  const idx = productos.findIndex(prod=>prod.id===p.id);
  if(idx>=0){
    productos[idx]=p;
    tabla.row(idx).data(p).draw();
  }else{
    productos.push(p);
    tabla.row.add(p).draw();
  }

  cerrarSidebar();
  Swal.fire('Guardado','Producto guardado correctamente','success');
}

function filtrosTabla(){
  const cat = $('#filtroCategoria').val();
  const est = $('#filtroEstado').val();
  const st  = $('#filtroStock').val();
  tabla.columns().search('');
  if(cat) tabla.column(2).search(cat);
  if(est!=='') tabla.column(5).search(est==1?'Activo':'Inactivo');
  if(st==='con') tabla.column(4).search('[1-9]');
  if(st==='sin') tabla.column(4).search('^0$');
  if(st==='bajo') tabla.column(4).search('^[1-9]$|^1[0-9]$');
  tabla.draw();
}
</script>

</body>
</html>
